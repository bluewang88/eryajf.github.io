(window.webpackJsonp=window.webpackJsonp||[]).push([[27],{551:function(s,a,n){"use strict";n.r(a);var t=n(8),e=Object(t.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[s._v("由于部署初期预估不足，使得 confluence 的应用数据写到了根分区当中，而根分区又只有 50G，现在附件越来越多，眼见磁盘将满，有句俗话说的好：我不来解决，谁又来解决！")]),s._v(" "),n("p",[s._v("事情可能不复杂，但是操作一旦出纰漏，也是非常重大的，因此写好操作流程，按章施工，以免出错。")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("发出维护通知，在夜深无人时操作。")])]),s._v(" "),n("li",[n("p",[s._v("先停止 NGINX，切断所有请求，以免有新的文章附件编辑提交。")])]),s._v(" "),n("li",[n("p",[s._v("提前将数据同步到将要迁移的目录之下，命令如下：\n"),n("code",[s._v("rsync -avz --delete /var/atlassian/ /confluence/atlassian/")])])]),s._v(" "),n("li",[n("p",[s._v("操作之前，记得再次执行如上命令，以保证数据一致。")])]),s._v(" "),n("li",[n("p",[s._v("停止 confluence 服务，使用如下命令：\n"),n("code",[s._v("/opt/atlassian/confluence/bin/stop-confluence.sh")])])]),s._v(" "),n("li",[n("p",[s._v("编辑 confluence 配置文件，更改如下内容：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /opt/atlassian/confluence/confluence/WEB-INF/classes/confluence-init.properties\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 改写如下配置文件的路径为迁移后的路径")]),s._v("\nconfluence.home "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" /var/atlassian/application-data/confluence\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("启动 confluence，命令如下：\n"),n("code",[s._v("/opt/atlassian/confluence/bin/start-confluence.sh")])])]),s._v(" "),n("li",[n("p",[s._v("查看日志，启动是否有异常，如果没有问题，可以将 NGINX 启动。")])])]),s._v(" "),n("p",[n("img",{attrs:{src:"https://tva3.sinaimg.cn/large/71cfeb93ly1gf5kj76ntdj21hc0xcaf0.jpg",alt:"img"}})]),s._v(" "),n("ol",[n("li",[s._v("访问服务，验证功能是否正常。")])]),s._v(" "),n("p",[n("code",[s._v("注意")]),s._v("：如果相关权限不正确，可能会导致部分功能加载失败，比如我迁移完成之后，发现编辑页面的"),n("code",[s._v("其他宏")]),s._v("功能点击无法正常使用，此时对比了老目录的权限，分别调整了属主属组，好像还不行，最后通过将 plugin 开头的目录全部给了 777 的权限，然后才能正常使用。")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("777")]),s._v(" -R plugins-*\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("再到页面，发现"),n("code",[s._v("其他宏")]),s._v("恢复使用。")]),s._v(" "),n("p",[s._v("加载失败的报错如下：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("http://ex.confluence.com/plugins/macrobrowser/browse-macros.action?detailed"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("false¯oMetadataClientCacheKey"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1589232968441")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" and may be stuck "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("configured threshold "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" this StuckThreadDetectionValve is "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" seconds"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(". There is/are "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" thread"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" total that are monitored by this Valve and may be stuck.\n java.lang.Throwable\n        at java.net.PlainSocketImpl.socketConnect"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Native Method"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])])])}),[],!1,null,null,null);a.default=e.exports}}]);